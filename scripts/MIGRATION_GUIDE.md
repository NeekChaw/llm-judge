# Supabase å•ä¾‹è¿ç§»æŒ‡å—

## èƒŒæ™¯

é¡¹ç›®ä¸­å­˜åœ¨ 105+ å¤„ä½¿ç”¨ `createClient()` åˆ›å»º Supabase å®¢æˆ·ç«¯ï¼Œå¯¼è‡´ï¼š
- å¹¶å‘è¿æ¥æ•°çˆ†ç‚¸ï¼ˆ50-500+ è¿æ¥ï¼‰
- å†…å­˜æ³„æ¼
- API å“åº”å»¶è¿Ÿé«˜ï¼ˆ500-2000msï¼‰

**é˜¶æ®µä¸€**å·²é€šè¿‡ä¿®æ”¹ `createClient()` è¿”å›å•ä¾‹è§£å†³äº†æ€§èƒ½é—®é¢˜ã€‚

**é˜¶æ®µäºŒ**æ˜¯ä»£ç è´¨é‡ä¼˜åŒ–ï¼Œå°†ä»£ç è¿ç§»åˆ°ç›´æ¥ä½¿ç”¨ `supabase` å•ä¾‹ã€‚

---

## å·¥å…·è„šæœ¬

### 1. verify-singleton-migration.sh - éªŒè¯è¿ç§»çŠ¶æ€

**ç”¨é€”**ï¼šæŸ¥çœ‹æ•´ä½“è¿ç§»è¿›åº¦å’Œå¾…è¿ç§»æ–‡ä»¶åˆ—è¡¨

```bash
./scripts/verify-singleton-migration.sh
```

**è¾“å‡ºç¤ºä¾‹**ï¼š
```
ğŸ“Š æ•´ä½“è¿ç§»è¿›åº¦:
  æ€»æ–‡ä»¶æ•°: 272
  ä»åœ¨ä½¿ç”¨ createClient(): 71
  å·²ä½¿ç”¨ supabase å•ä¾‹: 13
  è¿ç§»è¿›åº¦: 15%

ğŸ¯ æ ¸å¿ƒåº“æ–‡ä»¶çŠ¶æ€:
  âš ï¸  subtask-generator.ts - ä»åœ¨ä½¿ç”¨ createClient() (5 æ¬¡)
  âš ï¸  evaluator-engine.ts - ä»åœ¨ä½¿ç”¨ createClient() (3 æ¬¡)
  âœ… worker.ts - å·²è¿ç§»åˆ°å•ä¾‹
```

---

### 2. migrate-to-singleton.sh - è¿ç§»å•ä¸ªæ–‡ä»¶

**ç”¨é€”**ï¼šå®‰å…¨åœ°è¿ç§»å•ä¸ªæ–‡ä»¶åˆ° supabase å•ä¾‹

```bash
./scripts/migrate-to-singleton.sh src/lib/subtask-generator.ts
```

**æ‰§è¡Œæµç¨‹**ï¼š
1. åˆ›å»ºå¤‡ä»½æ–‡ä»¶
2. æ˜¾ç¤ºå½“å‰çŠ¶æ€
3. è¯¢é—®ç¡®è®¤
4. æ‰§è¡Œè¿ç§»ï¼ˆä¿®æ”¹å¯¼å…¥ + åˆ é™¤æœ¬åœ°å˜é‡ï¼‰
5. éªŒè¯ç»“æœ
6. æ˜¾ç¤ºä»£ç å˜æ›´

**è¿ç§»å†…å®¹**ï¼š
```typescript
// ä¿®æ”¹å‰
import { createClient } from '@/lib/supabase';

function someFunction() {
  const supabase = createClient();
  // ä½¿ç”¨ supabase...
}

// ä¿®æ”¹å
import { supabase } from '@/lib/supabase';

function someFunction() {
  // Using global supabase singleton
  // ä½¿ç”¨ supabase...
}
```

---

### 3. migrate-core-libraries.sh - æ‰¹é‡è¿ç§»æ ¸å¿ƒæ–‡ä»¶

**ç”¨é€”**ï¼šä¸€é”®è¿ç§»æ‰€æœ‰æ ¸å¿ƒåº“æ–‡ä»¶ï¼ˆé˜¶æ®µ 2.1ï¼‰

```bash
./scripts/migrate-core-libraries.sh
```

**è¿ç§»æ–‡ä»¶**ï¼š
- `src/lib/subtask-generator.ts` (5å¤„)
- `src/lib/evaluator-engine.ts` (3å¤„)

**æ³¨æ„**ï¼š`worker.ts` ä½¿ç”¨åŠ¨æ€å¯¼å…¥ï¼Œä¸åŒ…å«åœ¨æ‰¹é‡è¿ç§»ä¸­

---

## è¿ç§»æµç¨‹ï¼ˆæ¨èï¼‰

### å¿«é€Ÿæ–¹æ¡ˆï¼šé˜¶æ®µ 2.1ï¼ˆ1-2å°æ—¶ï¼‰

```bash
# ç¬¬1æ­¥ï¼šæŸ¥çœ‹å½“å‰çŠ¶æ€
./scripts/verify-singleton-migration.sh

# ç¬¬2æ­¥ï¼šæ‰¹é‡è¿ç§»æ ¸å¿ƒåº“æ–‡ä»¶
./scripts/migrate-core-libraries.sh

# ç¬¬3æ­¥ï¼šæµ‹è¯•éªŒè¯
npm run build
npm run test:api

# ç¬¬4æ­¥ï¼šæ‰‹åŠ¨åŠŸèƒ½æµ‹è¯•
# - åˆ›å»ºæ–°ä»»åŠ¡
# - éªŒè¯å­ä»»åŠ¡ç”Ÿæˆ
# - è¿è¡Œ PROMPT/REGEX/CODE è¯„åˆ†å™¨

# ç¬¬5æ­¥ï¼šæäº¤æ›´æ”¹
git add src/lib/subtask-generator.ts src/lib/evaluator-engine.ts
git commit -m "refactor: Migrate core libraries to supabase singleton (phase 2.1)"
git push origin main
```

### å®Œæ•´æ–¹æ¡ˆï¼šé˜¶æ®µ 2.1 + 2.2ï¼ˆ1å¤©ï¼‰

**ä¸Šåˆï¼ˆ4å°æ—¶ï¼‰**ï¼š
```bash
# æ‰§è¡Œé˜¶æ®µ 2.1
./scripts/migrate-core-libraries.sh
# ... æµ‹è¯• ...
# ... æäº¤ ...
```

**ä¸‹åˆï¼ˆ4å°æ—¶ï¼‰**ï¼š
```bash
# è¿ç§» API è·¯ç”±ï¼ˆåˆ†æ‰¹ï¼‰

# æ‰¹æ¬¡1: tasks/stats
./scripts/migrate-to-singleton.sh src/app/api/tasks/stats/route.ts
./scripts/migrate-to-singleton.sh src/app/api/tasks/batch-delete/route.ts
# ... æµ‹è¯• ...
# ... æäº¤ ...

# æ‰¹æ¬¡2-6: é‡å¤ä¸Šè¿°æµç¨‹
```

---

## æµ‹è¯•æ¸…å•

### ç¼–è¯‘æµ‹è¯•
```bash
npm run build
```

### å•å…ƒæµ‹è¯•
```bash
npm run test:api
```

### åŠŸèƒ½æµ‹è¯•

**subtask-generator.ts è¿ç§»å**ï¼š
- [ ] è®¿é—® http://localhost:3000/workbench/tasks/new
- [ ] åˆ›å»ºæ–°ä»»åŠ¡ï¼ˆä»»æ„æ¨¡æ¿ï¼‰
- [ ] æŸ¥çœ‹ä»»åŠ¡è¯¦æƒ…ï¼Œç¡®è®¤å­ä»»åŠ¡å·²ç”Ÿæˆ
- [ ] æ£€æŸ¥æ•°æ®åº“ï¼š`SELECT * FROM evaluation_tasks ORDER BY created_at DESC LIMIT 1`

**evaluator-engine.ts è¿ç§»å**ï¼š
- [ ] è¿è¡Œä¸€ä¸ªåŒ…å« PROMPT è¯„åˆ†å™¨çš„ä»»åŠ¡
- [ ] è¿è¡Œä¸€ä¸ªåŒ…å« REGEX è¯„åˆ†å™¨çš„ä»»åŠ¡
- [ ] è¿è¡Œä¸€ä¸ªåŒ…å« CODE è¯„åˆ†å™¨çš„ä»»åŠ¡
- [ ] éªŒè¯è¯„åˆ†ç»“æœæ­£ç¡®æ˜¾ç¤º

**API è·¯ç”±è¿ç§»å**ï¼š
- [ ] æµ‹è¯•å¯¹åº”çš„ API ç«¯ç‚¹
- [ ] éªŒè¯å“åº”æ•°æ®æ ¼å¼æ­£ç¡®
- [ ] æ£€æŸ¥å“åº”æ—¶é—´ï¼ˆåº”ä¿æŒä¸å˜ï¼‰

---

## å›æ»šæ–¹æ¡ˆ

### å•ä¸ªæ–‡ä»¶å›æ»š
```bash
# ä½¿ç”¨å¤‡ä»½æ–‡ä»¶
cp src/lib/subtask-generator.ts.backup.20251116_* src/lib/subtask-generator.ts

# æˆ–ä½¿ç”¨ Git
git checkout -- src/lib/subtask-generator.ts
```

### æ‰¹é‡å›æ»š
```bash
git checkout -- src/lib/subtask-generator.ts src/lib/evaluator-engine.ts
```

---

## é¢„æœŸæ”¶ç›Š

### é˜¶æ®µä¸€ï¼ˆå·²å®Œæˆï¼‰
- âœ… è¿æ¥æ•°: 50-500+ â†’ 1-10 (95% â†“)
- âœ… å»¶è¿Ÿ: 500-2000ms â†’ 50-200ms (75-90% â†“)
- âœ… å†…å­˜: æŒç»­å¢é•¿ â†’ ç¨³å®š

### é˜¶æ®µäºŒï¼ˆä»£ç è´¨é‡ï¼‰
- âœ… **ä»£ç ä¸€è‡´æ€§**: ç»Ÿä¸€ä½¿ç”¨ `supabase` å•ä¾‹
- âœ… **å¯è¯»æ€§**: å‡å°‘ ~70 è¡Œå†—ä½™ä»£ç 
- âœ… **å¯ç»´æŠ¤æ€§**: æ–°å¼€å‘è€…ä¸ä¼šè¯¯ç”¨
- âš ï¸ **æ€§èƒ½**: æ— æ˜æ˜¾å˜åŒ–ï¼ˆé˜¶æ®µä¸€å·²ä¿®å¤ï¼‰

---

## é£é™©ä¸ç¼“è§£

### ä½é£é™©
- âœ… Supabase æ˜¯æ— çŠ¶æ€ HTTP å®¢æˆ·ç«¯
- âœ… æ¯æ¬¡ API è°ƒç”¨éƒ½æ˜¯ç‹¬ç«‹è¯·æ±‚
- âœ… ä¸å½±å“äº‹åŠ¡éš”ç¦»
- âœ… ä¸å½±å“å¹¶å‘å¤„ç†

### ç¼“è§£æªæ–½
- âœ… è‡ªåŠ¨å¤‡ä»½
- âœ… Git ç‰ˆæœ¬æ§åˆ¶
- âœ… åˆ†æ‰¹è¿ç§»
- âœ… æ¯æ‰¹ç‹¬ç«‹æµ‹è¯•
- âœ… å¯å¿«é€Ÿå›æ»š

---

## å¸¸è§é—®é¢˜

### Q1: ä¸ºä»€ä¹ˆ worker.ts ä¸è¿ç§»ï¼Ÿ
**A**: worker.ts ä½¿ç”¨åŠ¨æ€å¯¼å…¥ `await import()`ï¼Œå¯èƒ½æ˜¯ä¸ºäº†é¿å…å¾ªç¯ä¾èµ–ã€‚é˜¶æ®µä¸€å·²ä¿®å¤æ€§èƒ½é—®é¢˜ï¼Œæ— éœ€æ”¹åŠ¨ã€‚

### Q2: è¿ç§»ä¼šå½±å“æ€§èƒ½å—ï¼Ÿ
**A**: ä¸ä¼šã€‚é˜¶æ®µä¸€å·²ç»è®© `createClient()` è¿”å›å•ä¾‹ï¼Œæ€§èƒ½å·²ä¼˜åŒ–ã€‚é˜¶æ®µäºŒåªæ˜¯ä»£ç æ¸…ç†ã€‚

### Q3: è¿ç§»ä¼šå½±å“åŠŸèƒ½å—ï¼Ÿ
**A**: ä¸ä¼šã€‚Supabase å®¢æˆ·ç«¯æ˜¯æ— çŠ¶æ€çš„ï¼Œæ¯æ¬¡è°ƒç”¨éƒ½æ˜¯ç‹¬ç«‹ HTTP è¯·æ±‚ï¼Œä¸å—å•ä¾‹å½±å“ã€‚

### Q4: å¿…é¡»æ‰§è¡Œé˜¶æ®µäºŒå—ï¼Ÿ
**A**: ä¸å¿…é¡»ã€‚é˜¶æ®µä¸€å·²è§£å†³æ€§èƒ½é—®é¢˜ã€‚é˜¶æ®µäºŒæ˜¯ä»£ç è´¨é‡ä¼˜åŒ–ï¼Œå¯ä»¥å»¶è¿Ÿæˆ–è·³è¿‡ã€‚

### Q5: API è·¯ç”±éœ€è¦è¿ç§»å—ï¼Ÿ
**A**: æ”¶ç›Šæœ‰é™ï¼Œä¼˜å…ˆçº§ä½ã€‚å¯ä»¥ä½œä¸ºä»£ç é‡æ„çš„ä¸€éƒ¨åˆ†é€æ­¥è¿›è¡Œã€‚

---

## å‚è€ƒ

- **é˜¶æ®µä¸€ä¿®å¤**: commit `1d31613` - createClient() è¿”å›å•ä¾‹
- **æ€§èƒ½å¯¹æ¯”**: è¯¦è§ Git æäº¤ä¿¡æ¯
- **æ¶æ„æ–‡æ¡£**: ARCHITECTURE.md
- **æ ¸å¿ƒæ–‡ä»¶æ¸…å•**: CORE_FILES.md

---

**æœ€åæ›´æ–°**: 2025-11-16
